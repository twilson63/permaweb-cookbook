# [ANS-102: バンドルされたデータ - JSON シリアライゼーション](https://github.com/ArweaveTeam/arweave-standards/blob/master/ans/ANS-102.md)

ステータス: 標準

## 概要

この文書では、バンドル化されたデータのデータ形式および読み書きの手順について説明します。バンドル化されたデータは、複数の論理的なデータトランザクション（本書では DataItem と呼びます）を 1 つのトップレベルトランザクションに書き込む方法です。DataItem は所有者、データ、タグ、target、signature、id といった点で通常のデータトランザクションと多くの共通点があります。異なる点は、トークンを転送する能力がなく、報酬も持たない点で、トップレベルのトランザクションが全てのバンドルデータに対する報酬を支払います。

## 動機

複数の論理的データトランザクションを 1 つのトランザクションにバンドルすることには、以下のような利点があります:

- DataItem の支払いを第三者に委任しつつ、DataItem を作成した人物の識別と署名を保持し、作成者が資金を持つウォレットを持つ必要がないようにするため。

- 複数の DataItem をグループとして書き込めるようにするため。

- 論理的に独立したデータ書き込みの Arweave ネットワークへのスループットを向上させるため。

## 参照実装

DataItem の作成、署名、検証およびバンドルの操作に関する参照実装は [TypeScript](https://github.com/ArweaveTeam/arweave-data) にあります。

## 仕様

### 1. トランザクション形式

#### 1.1 トランザクションタグ

DataItem のバンドルは、以下の 2 つのタグが存在することを MUST とします。

- `Bundle-Format` — バンドルフォーマットを示す文字列。本標準のフォーマットは `json`
- `Bundle-Version` — バージョン文字列。本標準で参照するバージョンは `1.0.0`

#### 1.2 トランザクション本文の形式

トランザクション本文の形式は、以下の形式の JSON オブジェクトです。

```
{
  items: [
    { DataItem },
    { DataItem }
  ]
}
```

#### 1.3 DataItem の形式

DataItem はトランザクションに類似したプロパティを持つ JSON オブジェクトです。

B64U エンコーディングはフィールドが Base64Url でエンコードされたバイナリであることを示します。

全てのプロパティは存在しなければなりません（MUST）。オプションの値については「空の値（Empty Value）」に示された値を使用しなければなりません（MUST）。

| フィールド | 説明                               | エンコーディング | 空の値         |
| ---------- | ---------------------------------- | ---------------- | -------------- |
| owner      | 所有者の公開鍵                     | B64U             |                |
| target     | この DataItem が送信されるアドレス | B64U             | 空文字列       |
| nonce      | リプレイ攻撃を防ぐための値         | B64U             | 空文字列       |
| tags       | タグオブジェクトの配列             | Json Array       | 空の Json 配列 |
| data       | データの内容                       | B64U             |                |
| signature  | owner によって生成された署名       | B64U             |                |
| id         | アイテムの id                      | B64U             |                |

タグオブジェクトは以下の 2 つのキーを持つ JSON オブジェクトです。タグオブジェクトは他のキーを持ってはなりません（MUST NOT）。

| フィールド | 説明       | エンコーディング | 空の値 |
| ---------- | ---------- | ---------------- | ------ |
| name       | タグの名前 | B64U             |        |
| value      | タグの値   | B64U             |        |

DataItem および Tags オブジェクト内のフィールドは、通常の Arweave トランザクションにおける対応物と同様の方法で扱うことができます。

DataItem の `nonce` フィールドはオプションであり、バンドリングゲートウェイが自身やそのユーザーに対するリプレイ攻撃からの保護を提供するために用いる任意の値です。

### 2. DataItem の署名と id

DataItem の署名および id は、Arweave 2.0 のトランザクション署名に類似した方法で構築されます。これは Arweave 2.0 の deep-hash アルゴリズムを使用します。2.0 deep-hash アルゴリズムは、二進データの任意にネストされた配列上で動作します。すなわち再帰型の `DeepHashChunk = Uint8Array | DeepHashChunk[]` です。

deep-hash アルゴリズムの参照実装は [TypeScript](https://github.com/ArweaveTeam/arweave-js/blob/b1c4b2e378a1eb7dc1fbfaeee41492eb908a60c6/src/common/lib/deepHash.ts) および [Erlang](https://github.com/ArweaveTeam/arweave/blob/b316173cd42a53a59036241f8e164b615db9b40d/apps/arweave/src/ar_deep_hash.erl) にあります。

DataItem に対して有効な署名を生成するために、DataItem の内容と静的なバージョンタグが deep-hash アルゴリズムに渡され、メッセージが得られます。このメッセージは DataItem の所有者によって署名され、署名が生成されます。DataItem の id はこの署名の SHA256 ダイジェストです。

署名のために deep-hash アルゴリズムに渡される正確な構造と内容は以下のとおりです:

```
[
  utf8Encoded("dataitem"),
  utf8Encoded("1"),
  owner,
  target,
  nonce,
  [
    ... [ tag.name, tag.value ],
    ... [ tag.name, tag.value ],
    ...
  ],
  data
]
```

### 3. DataItem バンドルの展開

DataItem のバンドルを読み取り展開するには、`items` 内の各 DataItem を検証アルゴリズムを用いて検証する必要があります。検証に失敗した個別のアイテムは破棄されなければなりません（MUST）。

稀なケースとして、同一の DataItem が複数のトランザクションに存在することがあります。すなわち、DataItem の内容と id が同一でありながら複数の Arweave トランザクションに存在する場合です。それらは同一であるため、いずれかのコピーを破棄して構いません。

### 4. DataItem バンドルの書き込み

DataItem のバンドルを書き込むには、各 DataItem を構築し署名した上で、セクション 1「トランザクション形式」に指定されたトランザクション本文の形式およびトランザクションタグを持つトランザクションに配置する必要があります。
