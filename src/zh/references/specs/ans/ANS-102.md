# [ANS-102：已绑定数据 - JSON 序列化](https://github.com/ArweaveTeam/arweave-standards/blob/master/ans/ANS-102.md)

状态：标准

## 摘要

本文件描述已绑定数据（bundled data）的数据格式以及读写指引。已绑定数据是一种将多个逻辑数据交易（在本文件中称为 DataItem）写入一个顶层交易的方式。DataItem 与一般数据交易具有相同的大多数属性，例如具有 owner、data、tags、target、signature 与 id。但不同之处在于它无法转移代币，且没有 reward，因为顶层交易会支付所有已绑定数据的 reward。

## 动机

将多个逻辑数据交易绑定到一个交易中可带来多项好处：

- 允许将 DataItem 的付款委托给第三方，同时维持建立该 DataItem 的人的身份与签章，而该人不需要拥有有余额的钱包。
- 允许多个 DataItem 作为一个群组被写入。
- 提升向 Arweave 网络写入在逻辑上独立的数据的吞吐量。

## 参考实现

关于 DataItem 的建立、签署与验证及与 bundle 一起工作的参考实现可在 [TypeScript](https://github.com/ArweaveTeam/arweave-data) 中取得。

## 规范

### 1. 交易格式

#### 1.1 交易 Tags

一个包含 DataItems 的 bundle MUST 包含下列两个 tag：

- `Bundle-Format`：描述 bundling 格式的字符串。本标准使用的格式为 `json`
- `Bundle-Version`：版本字符串。本标准所述之版本为 `1.0.0`

#### 1.2 交易主体格式

交易主体的格式为下列 JSON 对象：

```
{
  items: [
    { DataItem },
    { DataItem }
  ]
}
```

#### 1.3 DataItem 格式

DataItem 为一个具有类似交易特性的 JSON 对象：

B64U Encoding 指该字段为 Base64Url 编码的二进制数据。

所有属性 MUST 出现；对于可选值，须使用“空值（Empty Value）”栏所指定的值。

| Field     | 说明                       | 編碼 (Encoding) | 空值 (Empty Value) |
| --------- | -------------------------- | --------------- | ------------------ |
| owner     | 拥有者的公开金钥           | B64U            |                    |
| target    | 此 DataItem 要发送到的地址 | B64U            | Empty String       |
| nonce     | 用以避免重放攻击的值       | B64U            | Empty String       |
| tags      | tag 对象的数组             | Json Array      | Empty Json Array   |
| data      | 数据内容                   | B64U            |                    |
| signature | 由 owner 所产生的签章      | B64U            |                    |
| id        | 该 item 的 id              | B64U            |                    |

tag 对象是一个含有下列两个键（keys）的 JSON 对象。tag 对象 MUST NOT 含有其他键。

| Field | 说明       | 編碼 (Encoding) | 空值 (Empty Value) |
| ----- | ---------- | --------------- | ------------------ |
| name  | tag 的名称 | B64U            |                    |
| value | tag 的数值 | B64U            |                    |

DataItem 与 Tags 对象中的字段，其处理方式可与一般 Arweave 交易中的对应字段相同。

DataItem 中的 `nonce` 字段为可选，且为任意值，允许 bundling gateway 提供对其或其用户的重放攻击保护。

### 2. DataItem 签章与 id

DataItem 的签章与 id 的建立方式类似于 Arweave 2.0 交易签章。它使用 Arweave 2.0 deep-hash 演算法。2.0 deep-hash 演算法作用于任意嵌套的二进制数组，即递归类型的 `DeepHashChunk = Uint8Array | DeepHashChunk[]`。

deep-hash 演算法的参考实现可见于 [TypeScript](https://github.com/ArweaveTeam/arweave-js/blob/b1c4b2e378a1eb7dc1fbfaeee41492eb908a60c6/src/common/lib/deepHash.ts) 与 [Erlang](https://github.com/ArweaveTeam/arweave/blob/b316173cd42a53a59036241f8e164b615db9b40d/apps/arweave/src/ar_deep_hash.erl)。

要为 DataItem 产生有效的签章，须将 DataItem 的内容与静态版本 tag 交给 deep-hash 演算法以取得讯息。此讯息由 DataItem 的 owner 签署以产生签章。DataItem 的 id 为该签章的 SHA256 摘要。

传入 deep-hash 演算法以取得要签署之讯息的确切结构与内容如下：

```
[
  utf8Encoded("dataitem"),
  utf8Encoded("1"),
  owner,
  target,
  nonce,
  [
    ... [ tag.name, tag.value ],
    ... [ tag.name, tag.value ],
    ...
  ],
  data
]
```

### 3. 展开（Expanding）一个 DataItems 的 bundle

要读取并展开一个 DataItems 的 bundle，应对 `items` 中的每一个 DataItem 使用验证演算法进行验证。未通过验证的个别项目 MUST 被丢弃。

在少见情况下，可能会有相同的 DataItem 出现在多于一个交易中。也就是说，DataItem 的内容与 id 完全相同但存在于多个 Arweave 交易中。由于它们彼此相同，任何一份副本都可以被丢弃。

### 4. 写入（Writing）一个 DataItems 的 bundle

要写入一个 DataItems 的 bundle，应建立并签署每个 DataItem，并将它们放入一个具有第 1 节「交易格式」中所指定之交易主体格式与交易 tags 的交易中。
