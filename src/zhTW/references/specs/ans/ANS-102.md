# [ANS-102：打包資料 - JSON 序列化](https://github.com/ArweaveTeam/arweave-standards/blob/master/ans/ANS-102.md)

Status: Standard

## 摘要

本文件描述打包資料（bundled data）的資料格式以及讀寫指引。打包資料是一種將多個邏輯資料交易（在本文件中稱為 DataItem）寫入一個最上層交易的方式。DataItem 與一般資料交易具有許多相同屬性，例如擁有者、資料、標籤、目標、簽章與 id。其不同之處在於它無法轉移代幣、也沒有報酬（reward），因為最上層交易會為所有打包資料支付報酬。

## 動機

將多個邏輯資料交易打包到一筆交易中有多項好處：

- 允許將 DataItem 的付款委託給第三方，同時保留建立該 DataItem 的人的身分與簽章，而該人不需要擁有帶有資金的錢包。
- 允許將多個 DataItem 以群組方式寫入。
- 提升向 Arweave 網路寫入邏輯上獨立資料的吞吐量。

## 參考實作

有關建立、簽署與驗證 DataItem 以及處理 bundle 的參考實作可在 [TypeScript](https://github.com/ArweaveTeam/arweave-data) 找到。

## 規範

### 1. 交易格式

#### 1.1 交易標籤

一個 DataItem 的 bundle 必須包含以下兩個標籤（tags）

- `Bundle-Format`：描述打包格式的字串。本標準的格式為 `json`
- `Bundle-Version`：版本字串。本標準所指之版本為 `1.0.0`

#### 1.2 交易本體格式

交易本體的格式為一個 JSON 物件，格式如下

```
{
  items: [
    { DataItem },
    { DataItem }
  ]
}
```

#### 1.3 DataItem 格式

DataItem 是一個 JSON 物件，具有類似交易的屬性：

B64U Encoding 表示該欄位為 Base64Url 編碼的二進位資料。

所有屬性必須存在；對於選用（optional）的值，必須使用「空值（Empty Value）」欄所指定的值。

| Field     | 描述                       | Encoding   | 空值（Empty Value）                |
| --------- | -------------------------- | ---------- | ---------------------------------- |
| owner     | 擁有者的公開金鑰           | B64U       |                                    |
| target    | 此 DataItem 所要送達的位址 | B64U       | 空字串（Empty String）             |
| nonce     | 用以防止重放攻擊的數值     | B64U       | 空字串（Empty String）             |
| tags      | 一個標籤物件的陣列         | Json Array | 空的 JSON 陣列（Empty Json Array） |
| data      | 資料內容                   | B64U       |                                    |
| signature | 由擁有者產生的簽章         | B64U       |                                    |
| id        | 該項目的 id                | B64U       |                                    |

標籤物件（tag object）是一個只含下列兩個鍵的 JSON 物件。標籤物件不得包含其他鍵。

| Field | 描述     | Encoding | 空值（Empty Value） |
| ----- | -------- | -------- | ------------------- |
| name  | 標籤名稱 | B64U     |                     |
| value | 標籤值   | B64U     |                     |

DataItem 與 Tags 物件中的欄位可以用與一般 Arweave 交易中相對應欄位相同的方式處理。

DataItem 中的 `nonce` 欄位為選用欄位，為任意值，允許打包閘道（bundling gateways）對其自身或其使用者提供防止重放攻擊的保護。

### 2. DataItem 的簽章與 id

DataItem 的簽章與 id 的建立方式類似於 Arweave 2.0 交易簽署。它使用 Arweave 2.0 的 deep-hash 演算法。2.0 deep-hash 演算法作用於任意巢狀的二進位資料陣列，即一種遞迴型態 `DeepHashChunk = Uint8Array | DeepHashChunk[]`。

deep-hash 演算法的參考實作可見於 [TypeScript](https://github.com/ArweaveTeam/arweave-js/blob/b1c4b2e378a1eb7dc1fbfaeee41492eb908a60c6/src/common/lib/deepHash.ts) 與 [Erlang](https://github.com/ArweaveTeam/arweave/blob/b316173cd42a53a59036241f8e164b615db9b40d/apps/arweave/src/ar_deep_hash.erl)。

為了產生有效的 DataItem 簽章，需將 DataItem 的內容與靜態版本標籤（static version tags）傳入 deep-hash 演算法以取得訊息（message）。此訊息由 DataItem 的擁有者簽署以產生簽章。DataItem 的 id 則為此簽章的 SHA256 摘要。

傳入 deep-hash 演算法以取得要簽署訊息的精確結構與內容如下：

```
[
  utf8Encoded("dataitem"),
  utf8Encoded("1"),
  owner,
  target,
  nonce,
  [
    ... [ tag.name, tag.value ],
    ... [ tag.name, tag.value ],
    ...
  ],
  data
]
```

### 3. 展開一個 DataItem 的 bundle

要讀取並展開一個 DataItem 的 bundle，應使用驗證演算法驗證 `items` 中的每個 DataItem。個別驗證失敗的項目必須被丟棄（discarded）。

在極少數情況下，完全相同的 DataItem 可能存在於多於一筆交易中。也就是說，DataItem 的內容與 id 完全相同但出現在多筆 Arweave 交易中。由於它們是相同的，任一複本皆可被丟棄。

### 4. 寫入一個 DataItem 的 bundle

要寫入一個 DataItem 的 bundle，應建立並簽署每個 DataItem，並將其置入符合第 1 節「交易格式」所規定的交易本體格式與交易標籤之交易中。
