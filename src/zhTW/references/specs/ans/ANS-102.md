# [ANS-102：Bundled Data - JSON Serialization](https://github.com/ArweaveTeam/arweave-standards/blob/master/ans/ANS-102.md)

狀態：Standard

## 摘要

本文件描述已綁定資料（bundled data）的資料格式以及讀寫指引。已綁定資料是一種將多個邏輯資料交易（在本文件中稱為 DataItem）寫入一個頂層交易的方式。DataItem 與一般資料交易具有相同的多數屬性，例如具有 owner、data、tags、target、signature 與 id。但不同之處在於它無法轉移代幣，且沒有 reward，因為頂層交易會支付所有已綁定資料的 reward。

## 動機

將多個邏輯資料交易綁定到一個交易中可帶來多項好處：

- 允許將 DataItem 的付款委託給第三方，同時維持建立該 DataItem 的人的身分與簽章，而該人不需要擁有有餘額的錢包。
- 允許多個 DataItem 作為一個群組被寫入。
- 提升向 Arweave 網路寫入在邏輯上獨立的資料的吞吐量。

## 參考實作

關於 DataItem 的建立、簽署與驗證及與 bundle 一起工作的參考實作在 [TypeScript](https://github.com/ArweaveTeam/arweave-data) 中可取得。

## 規範

### 1. 交易格式

#### 1.1 交易 Tags

一個包含 DataItems 的 bundle MUST 包含下列兩個 tag：

- `Bundle-Format`：描述 bundling 格式的字串。本標準使用的格式為 `json`
- `Bundle-Version`：版本字串。本標準所述之版本為 `1.0.0`

#### 1.2 交易主體格式

交易主體的格式為下列 JSON 物件：

```
{
  items: [
    { DataItem },
    { DataItem }
  ]
}
```

#### 1.3 DataItem 格式

DataItem 為一個具有類似交易特性的 JSON 物件：

B64U Encoding 指該欄位為 Base64Url 編碼之二進位資料。

所有屬性 MUST 出現；對於可選值，須使用「空值（Empty Value）」欄所指定的值。

| Field     | 說明                       | 編碼 (Encoding) | 空值 (Empty Value) |
| --------- | -------------------------- | --------------- | ------------------ |
| owner     | 擁有者的公開金鑰           | B64U            |                    |
| target    | 此 DataItem 要發送到的地址 | B64U            | Empty String       |
| nonce     | 用以避免重放攻擊的值       | B64U            | Empty String       |
| tags      | tag 物件的陣列             | Json Array      | Empty Json Array   |
| data      | 資料內容                   | B64U            |                    |
| signature | 由 owner 所產生的簽章      | B64U            |                    |
| id        | 該 item 的 id              | B64U            |                    |

tag 物件是一個含有下列兩個鍵（keys）的 JSON 物件。tag 物件 MUST NOT 含有其他鍵。

| Field | 說明       | 編碼 (Encoding) | 空值 (Empty Value) |
| ----- | ---------- | --------------- | ------------------ |
| name  | tag 的名稱 | B64U            |                    |
| value | tag 的數值 | B64U            |                    |

DataItem 與 Tags 物件中的欄位，其處理方式可與一般 Arweave 交易中的對應欄位相同。

DataItem 中的 `nonce` 欄位為可選，且為任意值，允許 bundling gateway 提供對其或其使用者的重放攻擊保護。

### 2. DataItem 簽章與 id

DataItem 的簽章與 id 的建立方式類似於 Arweave 2.0 交易簽章。它使用 Arweave 2.0 deep-hash 演算法。2.0 deep-hash 演算法作用於任意巢狀的二進位陣列，即遞迴型態的 `DeepHashChunk = Uint8Array | DeepHashChunk[]`。

deep-hash 演算法的參考實作可見於 [TypeScript](https://github.com/ArweaveTeam/arweave-js/blob/b1c4b2e378a1eb7dc1fbfaeee41492eb908a60c6/src/common/lib/deepHash.ts) 與 [Erlang](https://github.com/ArweaveTeam/arweave/blob/b316173cd42a53a59036241f8e164b615db9b40d/apps/arweave/src/ar_deep_hash.erl)。

要為 DataItem 產生有效的簽章，須將 DataItem 的內容與靜態版本 tag 交給 deep-hash 演算法以取得訊息。此訊息由 DataItem 的 owner 簽署以產生簽章。DataItem 的 id 為該簽章的 SHA256 摘要。

傳入 deep-hash 演算法以取得要簽署之訊息的確切結構與內容如下：

```
[
  utf8Encoded("dataitem"),
  utf8Encoded("1"),
  owner,
  target,
  nonce,
  [
    ... [ tag.name, tag.value ],
    ... [ tag.name, tag.value ],
    ...
  ],
  data
]
```

### 3. 展開（Expanding）一個 DataItems 的 bundle

要讀取並展開一個 DataItems 的 bundle，應對 `items` 中的每一個 DataItem 使用驗證演算法進行驗證。未通過驗證的個別項目 MUST 被丟棄。

在少見情況下，可能會有相同的 DataItem 出現在多於一個交易中。也就是說，DataItem 的內容與 id 完全相同但存在於多個 Arweave 交易中。由於它們互相相同，任何一份拷貝都可以被丟棄。

### 4. 寫入（Writing）一個 DataItems 的 bundle

要寫入一個 DataItems 的 bundle，應建立並簽署每個 DataItem，並將它們放入一個具有第 1 節「交易格式」中所指定之交易主體格式與交易 tags 的交易中。
