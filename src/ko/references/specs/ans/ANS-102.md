# [ANS-102: 번들된 데이터 - JSON 직렬화](https://github.com/ArweaveTeam/arweave-standards/blob/master/ans/ANS-102.md)

상태: 표준

## 개요

이 문서는 번들된 데이터(bundled data)의 데이터 형식과 읽기 및 쓰기 지침을 설명합니다. 번들된 데이터는 여러 개의 논리적 데이터 트랜잭션(이 문서에서는 DataItem으로 지칭)을 하나의 최상위 트랜잭션에 기록하는 방식입니다. DataItem은 소유자(owner), 데이터(data), 태그(tags), 대상(target), 서명(signature), 아이디(id) 등 일반 데이터 트랜잭션과 많은 속성을 공유합니다. 다만 토큰을 전송하는 기능이나 보상(reward)은 없으며, 최상위 트랜잭션이 번들된 모든 데이터에 대한 보상을 지불한다는 점이 다릅니다.

## 동기

여러 개의 논리적 데이터 트랜잭션을 하나의 트랜잭션으로 번들링하면 다음과 같은 이점이 있습니다:

- DataItem을 생성한 사람의 정체성과 서명을 유지하면서, 해당 사람이 자금이 있는 지갑을 가질 필요 없이 제3자에게 DataItem에 대한 결제 위임을 허용합니다.
- 여러 DataItem을 그룹으로 기록할 수 있도록 합니다.
- Arweave 네트워크에 대한 논리적으로 독립적인 데이터 쓰기의 처리량을 증가시킵니다.

## 참조 구현

DataItem의 생성, 서명, 검증 및 번들 작업에 대한 참조 구현은 [TypeScript](https://github.com/ArweaveTeam/arweave-data)로 제공됩니다.

## 명세

### 1. 트랜잭션 형식

#### 1.1 트랜잭션 태그

DataItem의 번들은 다음 두 태그가 반드시 존재해야 합니다

- `Bundle-Format` 번들링 형식을 설명하는 문자열. 이 표준의 형식은 `json`입니다.
- `Bundle-Version` 버전 문자열. 이 표준에서 참조되는 버전은 `1.0.0`입니다.

#### 1.2 트랜잭션 본문 형식

트랜잭션 본문 형식은 다음과 같은 JSON 객체입니다

```
{
  items: [
    { DataItem },
    { DataItem }
  ]
}
```

#### 1.3 DataItem 형식

DataItem은 트랜잭션과 유사한 속성을 갖는 JSON 객체입니다:

B64U 인코딩은 필드가 Base64Url로 인코딩된 이진 데이터임을 나타냅니다.

모든 속성은 반드시 존재해야 하며, 선택적 값의 경우 '빈 값' 칸에 있는 값을 사용해야 합니다.

| 필드      | 설명                                 | 인코딩     | 빈 값        |
| --------- | ------------------------------------ | ---------- | ------------ |
| owner     | 소유자의 공개 키                     | B64U       |              |
| target    | 이 DataItem이 전송되는 주소          | B64U       | 빈 문자열    |
| nonce     | 재생(replay) 공격을 방지하기 위한 값 | B64U       | 빈 문자열    |
| tags      | 태그 객체들의 배열                   | Json Array | 빈 Json 배열 |
| data      | 데이터 내용                          | B64U       |              |
| signature | 소유자에 의해 생성된 서명            | B64U       |              |
| id        | 아이템의 id                          | B64U       |              |

태그 객체는 다음 두 키를 갖는 JSON 객체입니다. 태그 객체는 다른 키를 가져서는 안 됩니다.

| 필드  | 설명      | 인코딩 | 빈 값 |
| ----- | --------- | ------ | ----- |
| name  | 태그 이름 | B64U   |       |
| value | 태그 값   | B64U   |       |

DataItem 및 태그 객체의 필드는 일반 Arweave 트랜잭션의 대응 필드와 동일한 방식으로 처리할 수 있습니다.

DataItem의 `nonce` 필드는 선택 사항이며, 번들 게이트웨이가 자신 또는 사용자에 대한 재생 공격으로부터 보호를 제공할 수 있도록 임의의 값입니다.

### 2. DataItem 서명 및 id

DataItem의 서명과 id는 Arweave 2.0 트랜잭션 서명과 유사한 방식으로 생성됩니다. Arweave 2.0의 deep-hash 알고리즘을 사용합니다. 2.0 deep-hash 알고리즘은 임의로 중첩된 이진 데이터 배열에 대해 동작합니다. 즉 재귀 타입인 `DeepHashChunk = Uint8Array | DeepHashChunk[]`입니다.

deep-hash 알고리즘에 대한 참조 구현은 [TypeScript](https://github.com/ArweaveTeam/arweave-js/blob/b1c4b2e378a1eb7dc1fbfaeee41492eb908a60c6/src/common/lib/deepHash.ts) 및 [Erlang](https://github.com/ArweaveTeam/arweave/blob/b316173cd42a53a59036241f8e164b615db9b40d/apps/arweave/src/ar_deep_hash.erl)에 있습니다.

DataItem에 대한 유효한 서명을 생성하려면, DataItem의 내용과 정적 버전 태그(static version tags)가 deep-hash 알고리즘에 전달되어 메시지를 얻습니다. 이 메시지는 DataItem의 소유자에 의해 서명되어 서명을 생성합니다. DataItem의 id는 이 서명의 SHA256 다이제스트입니다.

메시지를 얻기 위해 deep-hash 알고리즘에 전달되는 정확한 구조와 내용은 다음과 같습니다:

```
[
  utf8Encoded("dataitem"),
  utf8Encoded("1"),
  owner,
  target,
  nonce,
  [
    ... [ tag.name, tag.value ],
    ... [ tag.name, tag.value ],
    ...
  ],
  data
]
```

### 3. DataItem 번들 확장

번들된 DataItem을 읽고 확장하려면, `items`에 있는 각 DataItem을 검증 알고리즘으로 검증해야 합니다. 검증에 실패한 개별 아이템은 반드시 폐기해야 합니다(MUST be discarded).

드문 경우지만 동일한 DataItem이 둘 이상의 트랜잭션에 존재할 수 있습니다. 즉, DataItem의 내용과 id가 동일하지만 여러 Arweave 트랜잭션에 존재할 수 있습니다. 동일하므로 그 중 어떤 복사본은 폐기할 수 있습니다.

### 4. DataItem 번들 쓰기

DataItem 번들을 쓰려면, 각 DataItem을 구성하고 서명한 다음 섹션 1. 트랜잭션 형식에 명시된 트랜잭션 본문 형식과 트랜잭션 태그를 가진 트랜잭션에 배치해야 합니다.
